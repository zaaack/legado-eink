{"version":3,"file":"bundle.8c07f7.js","sources":["../src/index.ts"],"sourcesContent":["import $ from \"jquery\";\nimport { Book, Shelf } from \"./types/shelf\";\nimport { Chapter, ChaptersRes } from \"./types/chapters\";\nimport { ChapterContent } from \"./types/chapter\";\nimport \"./index.scss\";\n\nconst base = \"http://192.168.31.246:1122\";\n\nfunction init() {\n  function setBase() {\n    localStorage.base = window.prompt(\"设置服务地址\");\n    init();\n  }\n  const renderTheme = () => {\n    return `设置主题(当前:${localStorage.theme === \"dark\" ? \"黑\" : \"白\"})`;\n  };\n  if (!localStorage.theme) {\n    localStorage.theme = \"dark\";\n  }\n  $.getJSON(`${base}/getBookshelf`)\n    .then((data: Shelf) => {\n      $(`<div>\n    <ul class=\"books\">\n    ${data.data\n      .map((b, i) => {\n        return `<li data-book-index=\"${i}\">${b.name}</li>`;\n      })\n      .join(\"\")}\n    </ul>\n    <button class=\"setBase\">设置服务地址</button>\n    <button class=\"setTheme\">${renderTheme()}</button>\n    </div>`)\n        .appendTo($(\"#root\").html(\"\"))\n        .on(\"click\", \"li\", (e) => {\n          let book = data.data[+$(e.target).data(\"book-index\")];\n          console.log(book);\n          openBook(book);\n        })\n        .on(\"click\", \".setBase\", setBase)\n        .on(\"click\", \".setTheme\", (e) => {\n          if (localStorage.theme === \"dark\") {\n            localStorage.theme = \"light\";\n          } else {\n            localStorage.theme = \"dark\";\n          }\n          $(e.target).html(renderTheme());\n          $(\"html\").data(\"theme\", localStorage.theme);\n        });\n    })\n    .fail((er) => {\n      console.error(er);\n      $('<button class=\"setBase\">设置服务地址</button>')\n        .appendTo(\"#root\")\n        .on(\"click\", setBase);\n    });\n  document.addEventListener(\"keydown\", (e) => {\n    if ([\"AudioVolumeDown\", \"ArrowRight\", \"ArrowDown\"].indexOf(e.key) >= 0) {\n      $(\".next\").trigger(\"click\");\n    } else if ([\"AudioVolumeUp\", \"ArrowLeft\", \"ArrowUp\"].indexOf(e.key) >= 0) {\n      $(\".prev\").trigger(\"click\");\n    }\n  });\n}\nlet curChapterIndex = 0;\nlet isOpening = false;\nfunction openChapter(\n  book: Book,\n  chapters: Chapter[],\n  chapterIndex: number,\n  type: \"prev\" | \"next\"\n) {\n  if (isOpening) return;\n  isOpening = true;\n  curChapterIndex = chapterIndex;\n  return $.when(\n    $.getJSON(`${base}/getBookContent`, {\n      url: book.bookUrl,\n      index: chapterIndex,\n    })\n      .then((data: ChapterContent) => {\n        $(\"#reader .title\").text(chapters[chapterIndex].title);\n        $(\"#reader .content\").text(data.data);\n        if (type === \"prev\") {\n          window.scrollTo(0, document.body.scrollHeight);\n        } else {\n          window.scrollTo(0, 0);\n        }\n        return $.ajax({\n          url: `${base}/saveBookProgress`,\n          data: JSON.stringify({\n            author: book.author,\n            durChapterIndex: chapterIndex,\n            durChapterPos: type === \"prev\" ? data.data.length : 0,\n            durChapterTime: 1684307625485,\n            durChapterTitle: chapters[chapterIndex].title,\n            name: book.name,\n          }),\n          method: \"post\",\n          dataType: \"json\",\n          contentType: \"application/json\",\n        });\n      })\n      .always(() => {\n        isOpening = false;\n      })\n  );\n}\n\nfunction openBook(book: Book) {\n  const PageHeight = window.innerHeight - 50 - 30 - 30;\n\n  $.when(\n    $.getJSON(`${base}/getChapterList`, {\n      url: book.bookUrl,\n    }),\n    $.getJSON(`${base}/getBookContent`, {\n      url: book.bookUrl,\n      index: book.durChapterIndex,\n    })\n  ).then(([chapters]: [ChaptersRes], [chapter]: [ChapterContent]) => {\n    curChapterIndex = book.durChapterIndex;\n    let ci = chapters.data[curChapterIndex];\n    $(`<div id=\"reader\">\n      <div class=\"header\">${ci.title}</div>\n      <div class=\"title\">${ci.title}</div>\n      <div class=\"content\">${chapter.data}</div>\n      <div class=\"buttons\">\n        <div class=\"prev\">上一页</div>\n        <div class=\"cat\">目录</div>\n        <div class=\"next\"=>下一页</div>\n      </div>\n    </div>`)\n      .appendTo($(\"#root\").html(\"\"))\n      .on(\"click\", \".prev\", (e) => {\n        if (window.scrollY <= 1) {\n          if (curChapterIndex - 1 < 0) {\n            alert(\"已经是第一章了\");\n          } else {\n            openChapter(book, chapters.data, curChapterIndex - 1, \"prev\");\n          }\n        } else {\n          window.scrollBy(0, -PageHeight);\n        }\n      })\n      .on(\"click\", \".next\", (e) => {\n        if (\n          window.scrollY >=\n          document.body.scrollHeight - window.innerHeight - 1\n        ) {\n          if (curChapterIndex + 1 >= book.totalChapterNum) {\n            alert(\"已经是最后一章了\");\n          } else {\n            openChapter(book, chapters.data, curChapterIndex + 1, \"next\");\n          }\n        } else {\n          window.scrollBy(0, PageHeight);\n        }\n      });\n  });\n}\ninit();\n"],"names":["base","curChapterIndex","isOpening","openChapter","book","chapters","chapterIndex","type","index","$","text","title","window","scrollTo","data","JSON","stringify","durChapterIndex","durChapterPos","length","durChapterTime","durChapterTitle","method","dataType","contentType","always","init","setBase","renderTheme","concat","localStorage","theme","getJSON","map","b","i","name","join","on","e","target","console","log","then","_a","_b","chapter","ci","scrollY","totalChapterNum","scrollBy","PageHeight","error","er","document","addEventListener","indexOf","key"],"mappings":"43CAMA,IAAAA,EAAA,6BAyDA,IAAAC,EAAA,EACAC,GAAA,EACA,SAAAC,EAAAC,EAAAC,EAAAC,EAAAC,GAME,IAAAL,iFAMIM,MAAAF,6BAGEG,EAAA,kBAAAC,KAAAL,EAAAC,GAAAK,mGAKEC,OAAAC,SAAA,EAAA,gDAIAC,KAAAC,KAAAC,UAAA,iBAEEC,gBAAAX,EACAY,cAAA,SAAAX,EAAAO,EAAAA,KAAAK,OAAA,EACAC,eAAA,cACAC,gBAAAhB,EAAAC,GAAAK,oBAGFW,OAAA,OACAC,SAAA,OACAC,YAAA,oBAEJ,IACCC,QAAA,mBAIP,EAlGA,SAAAC,IACE,SAAAC,8CAEED,IAEF,IAAAE,EAAA,WACE,MAAA,WAAAC,OAAA,SAAAC,aAAAC,MAAA,IAAA,IAAA,IACF,EACAD,aAAAC,QACED,aAAAC,MAAA,QAEFtB,EAAAuB,QAAA,GAAAH,OAAA7B,EAAA,oCAEIS,EAAA,sCAAAoB,OAAAf,EAAAA,KAGCmB,KAAA,SAAAC,EAAAC,GACC,MAAA,wBAAAN,OAAAM,EAAA,MAAAN,OAAAK,EAAAE,KAAA,QACF,IACCC,KAAA,IAAA,2FAAAR,OAAAD,IAAA,wDAMEU,GAAA,QAAA,MAAA,SAAAC,GACC,IAAAnC,EAAAU,EAAAA,MAAAL,EAAA8B,EAAAC,QAAA1B,KAAA,eACA2B,QAAAC,IAAAtC,GAyEV,SAAAA,yLAUKuC,MAAA,SAAAC,EAAAC,GACM,IAAAxC,EAAAuC,EAAA,GAA2BE,EAAAD,EAAA,GAClC5C,EAAAG,EAAAa,gCAEAR,EAAA,gDAAAoB,OAAAkB,EAAApC,MAAA,qCAAAkB,OAAAkB,EAAApC,MAAA,uCAAAkB,OAAAiB,EAAAhC,KAAA,8MAWGwB,GAAA,QAAA,SAAA,SAAAC,GACC3B,OAAAoC,SAAA,EACE/C,EAAA,EAAA,mBAGEE,EAAAC,EAAAC,EAAAS,KAAAb,EAAA,EAAA,6BAKN,IACCqC,GAAA,QAAA,SAAA,SAAAC,mEAKGtC,EAAA,GAAAG,EAAA6C,kCAGE9C,EAAAC,EAAAC,EAAAS,KAAAb,EAAA,EAAA,QAGFW,OAAAsC,SAAA,EAAAC,EAEJ,GACJ,GACF,IA1HQ,IACCb,GAAA,QAAA,WAAAX,GACAW,GAAA,QAAA,aAAA,SAAAC,GACC,SAAAT,aAAAC,MACED,aAAAC,MAAA,QAEAD,aAAAC,MAAA,6BAGFtB,EAAA,QAAAK,KAAA,QAAAgB,aAAAC,MACF,GACJ,sBAEEU,QAAAW,MAAAC,kEAGGf,GAAA,QAAAX,EACL,IACF2B,SAAAC,iBAAA,WAAA,SAAAhB,GACE,CAAA,kBAAA,aAAA,aAAAiB,QAAAjB,EAAAkB,MAAA,8BAEO,CAAA,gBAAA,YAAA,WAAAD,QAAAjB,EAAAkB,MAAA,8BAGT,GACF,CAkGA/B"}